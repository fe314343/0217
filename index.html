<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專業全功能抽獎系統 PRO</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- SheetJS for Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .animate-pulse-slow { animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="bg-slate-100 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // 簡單圖示組件（模擬 Lucide）
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size }}></i>;
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('draw'); 
            const [participants, setParticipants] = useState([]);
            const [prizes, setPrizes] = useState([
                { id: 1, name: '特獎', count: 1, remaining: 1 },
                { id: 2, name: '頭獎', count: 3, remaining: 3 },
                { id: 3, name: '二獎', count: 5, remaining: 5 },
            ]);
            const [winners, setWinners] = useState([]);
            const [isRolling, setIsRolling] = useState(false);
            const [currentRoller, setCurrentRoller] = useState("準備抽獎");
            const [selectedPrizeId, setSelectedPrizeId] = useState(1);
            const [tempParticipantInput, setTempParticipantInput] = useState("");
            
            const rollInterval = useRef(null);
            const fileInputRef = useRef(null);

            // 本地存儲初始化
            useEffect(() => {
                const savedParticipants = localStorage.getItem('lottery_participants');
                const savedPrizes = localStorage.getItem('lottery_prizes');
                const savedWinners = localStorage.getItem('lottery_winners');
                if (savedParticipants) setParticipants(JSON.parse(savedParticipants));
                if (savedPrizes) setPrizes(JSON.parse(savedPrizes));
                if (savedWinners) setWinners(JSON.parse(savedWinners));
                if (window.lucide) window.lucide.createIcons();
            }, []);

            useEffect(() => {
                localStorage.setItem('lottery_participants', JSON.stringify(participants));
                localStorage.setItem('lottery_prizes', JSON.stringify(prizes));
                localStorage.setItem('lottery_winners', JSON.stringify(winners));
            }, [participants, prizes, winners]);

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const bstr = evt.target.result;
                        const wb = XLSX.read(bstr, { type: 'binary' });
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
                        const importedNames = data
                            .map(row => row[0])
                            .filter(name => name && String(name).trim() !== "" && String(name).toLowerCase() !== "name")
                            .map(name => String(name).trim());
                        const uniqueNames = [...new Set([...participants, ...importedNames])];
                        setParticipants(uniqueNames);
                        alert(`成功匯入 ${importedNames.length} 筆名單！`);
                    } catch (error) {
                        alert("讀取檔案失敗！");
                    }
                };
                reader.readAsBinaryString(file);
                e.target.value = null;
            };

            const addManual = () => {
                const names = tempParticipantInput.split(/[\n,，\t]/).map(n => n.trim()).filter(n => n && !participants.includes(n));
                setParticipants([...participants, ...names]);
                setTempParticipantInput("");
            };

            const startDraw = () => {
                const prize = prizes.find(p => p.id === selectedPrizeId);
                const pool = participants.filter(p => !winners.some(w => w.name === p));
                if (!prize || prize.remaining <= 0 || pool.length === 0) {
                    alert("抽獎條件不足！");
                    return;
                }
                setIsRolling(true);
                rollInterval.current = setInterval(() => {
                    setCurrentRoller(pool[Math.floor(Math.random() * pool.length)]);
                }, 80);
                setTimeout(stopDraw, 2500);
            };

            const stopDraw = () => {
                clearInterval(rollInterval.current);
                setIsRolling(false);
                const prize = prizes.find(p => p.id === selectedPrizeId);
                const pool = participants.filter(p => !winners.some(w => w.name === p));
                const winner = pool[Math.floor(Math.random() * pool.length)];
                setCurrentRoller(winner);
                setWinners([{ name: winner, prizeName: prize.name, time: new Date().toLocaleTimeString() }, ...winners]);
                setPrizes(prizes.map(p => p.id === selectedPrizeId ? { ...p, remaining: p.remaining - 1 } : p));
            };

            const exportCSV = () => {
                const headers = "\uFEFF中獎序號,姓名,獎項,時間\n";
                const rows = winners.map((w, i) => `${winners.length - i},${w.name},${w.prizeName},${w.time}`).join("\n");
                const blob = new Blob([headers + rows], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "抽獎結果.csv";
                link.click();
            };

            return (
                <div className="min-h-screen">
                    <nav className="bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b border-slate-200">
                        <div className="max-w-6xl mx-auto px-6 h-20 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="bg-blue-600 p-2 rounded-xl text-white shadow-lg"><Icon name="trophy" size={24} /></div>
                                <h1 className="text-xl font-black">LUCKY<span className="text-blue-600">PRO</span></h1>
                            </div>
                            <div className="flex bg-slate-100 p-1 rounded-xl">
                                {['draw', 'setup', 'history'].map(tab => (
                                    <button 
                                        key={tab} 
                                        onClick={() => setActiveTab(tab)}
                                        className={`px-6 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === tab ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}
                                    >
                                        {tab === 'draw' ? '開始抽獎' : tab === 'setup' ? '名單設定' : '中獎清單'}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-4xl mx-auto px-6 py-12">
                        {activeTab === 'draw' && (
                            <div className="flex flex-col items-center space-y-10 py-10">
                                <div className="flex flex-wrap justify-center gap-3">
                                    {prizes.map(p => (
                                        <button 
                                            key={p.id} 
                                            onClick={() => !isRolling && setSelectedPrizeId(p.id)}
                                            className={`px-6 py-3 rounded-2xl font-bold transition-all border ${selectedPrizeId === p.id ? 'bg-blue-600 text-white border-blue-600 shadow-xl' : 'bg-white text-slate-500 border-slate-200 hover:border-blue-400'}`}
                                        >
                                            {p.name} <span className="text-xs opacity-70 ml-2">剩 {p.remaining}</span>
                                        </button>
                                    ))}
                                </div>
                                <div className="w-full bg-white rounded-[40px] p-20 shadow-2xl text-center relative overflow-hidden border border-white">
                                    <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-400 to-indigo-600" />
                                    <div className="text-slate-400 text-sm font-bold tracking-widest uppercase mb-8">{isRolling ? "正在挑選幸運兒..." : "等待啟動"}</div>
                                    <div className={`text-6xl md:text-8xl font-black mb-12 min-h-[1.2em] ${isRolling ? 'text-blue-600 animate-pulse-slow' : 'text-slate-800'}`}>
                                        {currentRoller}
                                    </div>
                                    <button 
                                        onClick={startDraw} 
                                        disabled={isRolling}
                                        className={`px-16 py-6 rounded-full text-2xl font-black transition-all transform active:scale-95 shadow-2xl ${isRolling ? 'bg-slate-100 text-slate-300' : 'bg-slate-900 text-white hover:bg-black'}`}
                                    >
                                        {isRolling ? "滾動中..." : "開始抽獎"}
                                    </button>
                                </div>
                                <div className="flex gap-12">
                                    <div className="text-center"><div className="text-3xl font-black">{participants.length - winners.length}</div><div className="text-xs text-slate-400 font-bold">候選</div></div>
                                    <div className="text-center"><div className="text-3xl font-black text-blue-600">{winners.length}</div><div className="text-xs text-slate-400 font-bold">已中獎</div></div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'setup' && (
                            <div className="space-y-8 animate-in fade-in duration-500">
                                <div className="bg-white p-8 rounded-3xl shadow-sm border border-slate-200">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-xl font-bold flex items-center gap-2"><Icon name="users" className="text-blue-500" /> 名單管理</h2>
                                        <button onClick={() => fileInputRef.current.click()} className="flex items-center gap-2 bg-green-50 text-green-700 px-4 py-2 rounded-xl font-bold border border-green-200 hover:bg-green-100 transition-all">
                                            <Icon name="upload" size={16} /> 匯入 Excel
                                        </button>
                                        <input type="file" ref={fileInputRef} onChange={handleFileUpload} className="hidden" accept=".xlsx,.csv" />
                                    </div>
                                    <textarea 
                                        className="w-full h-40 p-4 border border-slate-200 rounded-2xl bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none transition-all mb-4" 
                                        placeholder="貼上姓名名單，每行一位..." 
                                        value={tempParticipantInput} 
                                        onChange={e => setTempParticipantInput(e.target.value)} 
                                    />
                                    <div className="flex justify-between">
                                        <button onClick={() => setParticipants([])} className="text-red-500 text-sm font-bold flex items-center gap-1"><Icon name="trash-2" size={16} /> 清空名單</button>
                                        <button onClick={addManual} className="bg-slate-900 text-white px-8 py-3 rounded-xl font-bold">確認加入</button>
                                    </div>
                                </div>
                                <div className="bg-white p-8 rounded-3xl shadow-sm border border-slate-200">
                                    <h2 className="text-xl font-bold mb-4 flex items-center gap-2"><Icon name="settings" className="text-amber-500" /> 獎項設定</h2>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {prizes.map(p => (
                                            <div key={p.id} className="flex justify-between items-center p-4 bg-slate-50 rounded-xl border border-slate-100">
                                                <span className="font-bold">{p.name} (名額: {p.count})</span>
                                                <button onClick={() => setPrizes(prizes.filter(x => x.id !== p.id))} className="text-slate-300 hover:text-red-500"><Icon name="trash-2" size={18} /></button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'history' && (
                            <div className="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden animate-in slide-in-from-bottom duration-500">
                                <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                                    <h2 className="font-bold flex items-center gap-2"><Icon name="history" className="text-indigo-500" /> 中獎榮譽榜</h2>
                                    <button onClick={exportCSV} className="text-blue-600 font-bold text-sm flex items-center gap-1"><Icon name="download" size={16} /> 匯出 CSV</button>
                                </div>
                                {winners.length === 0 ? (
                                    <div className="p-20 text-center text-slate-300 font-bold">目前尚無中獎紀錄</div>
                                ) : (
                                    <div className="divide-y divide-slate-100">
                                        {winners.map((w, i) => (
                                            <div key={i} className="p-6 flex items-center justify-between hover:bg-slate-50 transition-colors">
                                                <div className="flex items-center gap-4">
                                                    <div className="w-10 h-10 rounded-lg bg-slate-900 text-white flex items-center justify-center font-black">{winners.length - i}</div>
                                                    <div><div className="font-bold text-lg">{w.name}</div><div className="text-xs text-slate-400">{w.time}</div></div>
                                                </div>
                                                <span className="bg-amber-100 text-amber-700 px-4 py-1 rounded-full font-bold text-sm">{w.prizeName}</span>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                    </main>

                    <footer className="fixed bottom-6 w-full flex justify-center pointer-events-none">
                        <div className="bg-white/90 backdrop-blur px-6 py-3 rounded-full shadow-2xl border border-slate-200 text-xs font-bold text-slate-400 flex items-center gap-3">
                            <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse" />
                            名單總計 {participants.length} 人 | 系統運作中
                        </div>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
