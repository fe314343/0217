<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 Â•ΩÈÅãÊîæÈ¶¨‰æÜ - Â∞àÊ•≠Èõ≤Á´ØÊäΩÁçéÁ≥ªÁµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700;900&family=Inter:wght@400;700;900&display=swap');
        
        body { 
            font-family: 'Inter', 'Noto Serif TC', serif; 
            background-color: #7f1d1d; 
            margin: 0; padding: 0; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            height: 100vh; width: 100vw;
        }

        .cny-bg {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cpath d='M10 50 Q25 40 40 50 T70 50 T100 50' fill='none' stroke='%23991b1b' stroke-width='2'/%3E%3Cpath d='M0 80 Q15 70 30 80 T60 80 T90 80' fill='none' stroke='%23991b1b' stroke-width='1'/%3E%3C/svg%3E");
            background-repeat: repeat;
        }

        .aspect-video-container {
            width: 100vw; height: 56.25vw; 
            max-height: 100vh; max-width: 177.78vh; 
            position: relative;
            background-color: rgba(153, 27, 27, 0.93);
            box-shadow: 0 0 100px rgba(0,0,0,0.8);
            border: 8px solid #d97706;
            border-radius: 1.5rem;
            overflow: hidden;
            display: flex; flex-direction: column;
            z-index: 10;
        }

        .animate-rolling { 
            animation: rolling 0.1s infinite; 
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
        }
        @keyframes rolling { 
            0% { transform: translateY(-1px); filter: blur(1px); } 
            50% { transform: translateY(1px); filter: blur(2px); } 
            100% { transform: translateY(-1px); filter: blur(1px); } 
        }

        .lantern-swing {
            animation: swing 3s ease-in-out infinite;
            transform-origin: top center;
        }
        @keyframes swing {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }

        ::-webkit-scrollbar { display: none; }
        .custom-scrollbar::-webkit-scrollbar { display: none; }
        
        .bounce-in {
            animation: bounceIn 0.8s cubic-bezier(0.36, 0, 0.66, -0.56) forwards;
        }
        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.3); }
            50% { opacity: 1; transform: scale(1.05); }
            70% { transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }

        .gold-glow {
            box-shadow: 0 0 40px rgba(251, 191, 36, 0.5), inset 0 0 30px rgba(255, 255, 255, 0.4);
        }
    </style>
</head>
<body class="cny-bg">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ============================================================
        // üîí Á≥ªÁµ±ÈÖçÁΩÆÂçÄ
        // ============================================================
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwP9BgU-84FT9rS-ASNDHAiOd20LU7XsPt4jX9-E7J0yqAfvjp5VfX-fZ4K6cnUa669pw/exec"; 

        const INITIAL_PRIZES = [
            { id: 1, name: 'üßß ÁâπÁçé', count: 1, batch: 1 },
            { id: 2, name: 'üßß È†≠Áçé', count: 2, batch: 1 },
            { id: 3, name: 'üßß Ë≤≥Áçé', count: 5, batch: 1 },
            { id: 4, name: 'üßß Á¨¨‰∏ÄÊ¨° 100‰∫∫', count: 100, batch: 20 },
            { id: 5, name: 'üßß Á¨¨‰∫åÊ¨° 100‰∫∫', count: 100, batch: 20 },
            { id: 6, name: 'üßß Á¨¨‰∏âÊ¨° 100‰∫∫', count: 100, batch: 20 }
        ];
        // ============================================================

        const Icon = ({ name, size = 20, className = "" }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (window.lucide && containerRef.current) {
                    containerRef.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    i.className = className;
                    i.style.width = `${size}px`;
                    i.style.height = `${size}px`;
                    containerRef.current.appendChild(i);
                    window.lucide.createIcons();
                }
            }, [name, size, className]);
            return <span ref={containerRef} className="inline-flex items-center justify-center leading-none" />;
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('draw'); 
            const [participants, setParticipants] = useState([]);
            const [prizes, setPrizes] = useState(INITIAL_PRIZES.map(p => ({ ...p, remaining: p.count })));
            const [winners, setWinners] = useState([]);
            const [totalWonCount, setTotalWonCount] = useState(0); 
            const [isRolling, setIsRolling] = useState(false);
            const [showResults, setShowResults] = useState(false); 
            const [currentDisplay, setCurrentDisplay] = useState([]); 
            const [selectedPrizeId, setSelectedPrizeId] = useState(1);
            const [syncStatus, setSyncStatus] = useState("loading");
            
            const rollInterval = useRef(null);

            const fetchCloudData = async () => {
                if (!GAS_API_URL) return;
                setSyncStatus("loading");
                try {
                    const response = await fetch(`${GAS_API_URL}?t=${new Date().getTime()}`);
                    const data = await response.json();
                    if (data.error) { setSyncStatus("error"); return; }

                    const loadedParticipants = data.participants || [];
                    const wonIds = data.wonIds || [];
                    const cloudPrizeCounts = data.prizeCounts || {}; 

                    setParticipants(loadedParticipants);
                    setTotalWonCount(wonIds.length);

                    const cloudWinners = wonIds.map(id => {
                        const person = loadedParticipants.find(p => String(p.id) === String(id));
                        return person ? { ...person, prizeName: "Â∑≤ÊñºÈõ≤Á´ØË®òÈåÑ", time: "-" } 
                        : { id: id, name: "Â∑≤ÁßªÈô§ÊàêÂì°", phone: "N/A", prizeName: "Â∑≤Ë®òÈåÑ", time: "-" };
                    });
                    
                    setWinners(cloudWinners.reverse());
                    setPrizes(INITIAL_PRIZES.map(p => ({
                        ...p,
                        remaining: Math.max(0, p.count - (cloudPrizeCounts[p.name] || 0))
                    })));
                    setSyncStatus("idle");
                } catch (err) { setSyncStatus("error"); }
            };

            useEffect(() => { fetchCloudData(); }, []);

            const syncToCloud = async (winnerData) => {
                if (!GAS_API_URL) return;
                try {
                    await fetch(GAS_API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(winnerData) });
                } catch (err) { console.error("Sync Error", err); }
            };

            const startDraw = () => {
                const prize = prizes.find(p => p.id === selectedPrizeId);
                const pool = participants.filter(p => !winners.some(w => String(w.id) === String(p.id)));
                if (!prize || prize.remaining <= 0) return alert("Ë©≤ÁçéÈ†ÖÂêçÈ°çÂ∑≤ÊªøÔºÅ");
                if (pool.length < prize.batch) return alert(`ÂêçÂñÆÂâ©È§ò‰∫∫Êï∏‰∏çË∂≥‰ª•ÊäΩÂá∫ ${prize.batch} ‰ΩçÔºÅ`);
                
                setShowResults(true); 
                setIsRolling(true);
                rollInterval.current = setInterval(() => {
                    const tempWinners = [];
                    for(let i=0; i < prize.batch; i++) {
                        tempWinners.push(pool[Math.floor(Math.random() * pool.length)].id);
                    }
                    setCurrentDisplay(tempWinners);
                }, 80);
                setTimeout(stopDraw, 3000);
            };

            const stopDraw = async () => {
                clearInterval(rollInterval.current);
                setIsRolling(false);
                setSyncStatus("syncing");

                const prize = prizes.find(p => p.id === selectedPrizeId);
                const pool = participants.filter(p => !winners.some(w => String(w.id) === String(p.id)));
                const shuffled = [...pool].sort(() => 0.5 - Math.random());
                const drawnWinners = shuffled.slice(0, prize.batch);
                
                setCurrentDisplay(drawnWinners.map(w => w.id));
                const now = new Date().toLocaleString();
                const newRecords = drawnWinners.map(w => ({
                    id: w.id, name: w.name, phone: w.phone, prizeName: prize.name, time: now
                }));

                setWinners(prev => [...newRecords, ...prev]);
                setTotalWonCount(prev => prev + prize.batch);
                setPrizes(prev => prev.map(p => 
                    p.id === selectedPrizeId ? { ...p, remaining: p.remaining - prize.batch } : p
                ));

                for(const record of newRecords) { await syncToCloud(record); }
                setSyncStatus("success");
                setTimeout(() => setSyncStatus("idle"), 2000);

                confetti({
                    particleCount: 250, spread: 100, origin: { y: 0.4 },
                    colors: ['#fbbf24', '#ef4444', '#ffffff', '#ffd700']
                });
            };

            const resetToSelection = () => {
                setShowResults(false);
                setCurrentDisplay([]);
            };

            return (
                <div className="aspect-video-container">
                    <div className="absolute top-0 left-10 lantern-swing hidden lg:block pointer-events-none z-0">
                        <div className="w-1 h-16 bg-amber-500 mx-auto"></div>
                        <div className="w-14 h-16 bg-red-600 rounded-full border-2 border-amber-400 shadow-xl flex items-center justify-center font-black text-amber-200 text-xl text-center leading-tight">Êò•<br/>Á¶è</div>
                    </div>
                    <div className="absolute top-0 right-10 lantern-swing hidden lg:block pointer-events-none z-0">
                        <div className="w-1 h-16 bg-amber-500 mx-auto"></div>
                        <div className="w-14 h-16 bg-red-600 rounded-full border-2 border-amber-400 shadow-xl flex items-center justify-center font-black text-amber-200 text-xl text-center leading-tight">Âêâ<br/>Á••</div>
                    </div>

                    <header className="flex justify-between items-center px-10 pt-4 pb-1 shrink-0 relative z-20">
                        <div className="flex items-center gap-4">
                            <div className="bg-amber-500 p-2 rounded-full shadow-[0_0_15px_#fbbf24]"><Icon name="sparkles" size={24} className="text-red-800" /></div>
                            <div>
                                <h1 className="text-3xl font-black tracking-tighter text-amber-400 drop-shadow-lg leading-tight">2026 Â•ΩÈÅãÊîæÈ¶¨‰æÜ</h1>
                                <p className="text-amber-200/60 text-[10px] font-bold tracking-widest uppercase leading-none">Double Verified Cloud Lottery</p>
                            </div>
                        </div>
                        
                        {!showResults && (
                            <div className="flex bg-red-900/50 p-1 rounded-xl border border-amber-600/30">
                                {[{ id: 'draw', label: 'ÊäΩÁçé', icon: 'play' }, { id: 'history', label: 'Ë®òÈåÑ', icon: 'award' }, { id: 'setup', label: 'ÂêçÂñÆ', icon: 'users' }].map(tab => (
                                    <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex items-center gap-2 px-5 py-2 rounded-lg text-xs font-black transition-all ${activeTab === tab.id ? 'bg-amber-500 text-red-900 shadow-lg' : 'text-amber-200/50 hover:text-amber-200'}`}>
                                        <Icon name={tab.icon} size={14} /> {tab.label}
                                    </button>
                                ))}
                            </div>
                        )}
                    </header>

                    <main className="flex-1 flex flex-col justify-center items-center relative z-20 px-6 overflow-hidden">
                        {syncStatus === "loading" ? (
                            <div className="flex flex-col items-center gap-4">
                                <div className="animate-spin text-amber-400"><Icon name="refresh-cw" size={48} /></div>
                                <p className="text-xl font-black text-amber-200 animate-pulse tracking-widest">ÂêåÊ≠•ÂæåÂè∞Êï∏Êìö‰∏≠...</p>
                            </div>
                        ) : (
                            <div className="w-full h-full flex flex-col items-center justify-center">
                                {activeTab === 'draw' && (
                                    <div className="w-full h-full flex flex-col items-center justify-center">
                                        {!showResults ? (
                                            <div className="flex flex-col items-center justify-center h-full gap-8 animate-in fade-in scale-in">
                                                <div className="flex gap-3 flex-wrap justify-center max-w-5xl">
                                                    {prizes.map(p => (
                                                        <button 
                                                            key={p.id} onClick={() => setSelectedPrizeId(p.id)} disabled={p.remaining <= 0}
                                                            className={`relative px-6 py-4 rounded-b-xl border-t-4 transition-all flex flex-col items-center min-w-[140px] ${
                                                                selectedPrizeId === p.id ? 'bg-amber-500 border-white text-red-900 scale-110 shadow-2xl z-10' 
                                                                : p.remaining <= 0 ? 'bg-red-950 border-gray-600 text-gray-500 opacity-40 grayscale'
                                                                : 'bg-red-900/60 border-amber-600/50 text-amber-500 hover:bg-red-800/80 hover:-translate-y-1'
                                                            }`}
                                                        >
                                                            <span className="text-sm font-black tracking-wider">{p.name}</span>
                                                            <span className="text-[10px] font-bold opacity-80 mt-1">{p.remaining <= 0 ? 'Â∑≤ÊäΩÂÆå' : `Ââ© ${p.remaining} ‰Ωç`}</span>
                                                        </button>
                                                    ))}
                                                </div>

                                                <button 
                                                    onClick={startDraw} disabled={prizes.find(px => px.id === selectedPrizeId)?.remaining <= 0}
                                                    className="group relative w-56 h-56 bg-gradient-to-br from-amber-400 to-amber-600 rounded-full flex flex-col items-center justify-center shadow-[0_0_50px_rgba(251,191,36,0.4)] border-8 border-white/20 active:scale-95 transition-all hover:brightness-110"
                                                >
                                                    <div className="absolute inset-0 rounded-full animate-ping bg-amber-400/20 group-hover:hidden"></div>
                                                    <Icon name="gift" size={40} className="text-red-800 mb-2" />
                                                    <span className="text-2xl font-black text-red-900 tracking-widest">ÈñãÂßãÊäΩÁçé</span>
                                                    <span className="text-[10px] font-bold text-red-800/60 uppercase">ÊäΩÂèñ {prizes.find(p=>p.id===selectedPrizeId)?.batch} ‰∫∫</span>
                                                </button>
                                            </div>
                                        ) : (
                                            <div className="w-full h-full flex flex-col items-center justify-center py-2 animate-in zoom-in duration-300">
                                                <div className="w-full h-[98%] bg-red-900/50 backdrop-blur-2xl rounded-[40px] p-4 border-2 border-amber-500/30 flex flex-col shadow-2xl relative overflow-hidden">
                                                    
                                                    <div className="flex items-center justify-center relative mb-2 h-14 shrink-0 px-4">
                                                        <div className="flex flex-col items-center">
                                                            <h3 className="text-amber-400 font-black tracking-[0.4em] text-2xl uppercase drop-shadow-md">
                                                                {isRolling ? "‚ú¶ ÂêâÁ••È´òÁÖß ¬∑ ÊäΩÁçé‰∏≠ ‚ú¶" : "‚ú¶ È¥ªÈÅãÁï∂È†≠ ¬∑ ÊÅ≠ÂñúÁç≤Áçé ‚ú¶"}
                                                            </h3>
                                                        </div>
                                                        
                                                        {!isRolling && (
                                                            <button 
                                                                onClick={resetToSelection}
                                                                className="absolute right-4 bg-white/95 text-red-900 px-4 py-1.5 rounded-full font-black text-xs shadow-xl hover:bg-amber-100 transition-all flex items-center gap-2 active:scale-95 border-2 border-amber-500 z-50"
                                                            >
                                                                <Icon name="rotate-ccw" size={14} /> ÊäΩ‰∏ã‰∏ÄËº™
                                                            </button>
                                                        )}
                                                    </div>

                                                    <div className="flex justify-center mb-2 shrink-0">
                                                        <div className="bg-amber-500 text-red-900 px-12 py-1 rounded-full text-sm font-black shadow-lg border border-white/30 tracking-widest">
                                                            {prizes.find(p=>p.id===selectedPrizeId)?.name}
                                                        </div>
                                                    </div>

                                                    <div className="flex-1 flex items-center justify-center overflow-hidden w-full max-w-[98%] mx-auto">
                                                        {currentDisplay.length === 1 ? (
                                                            /* ÁâπÁçé„ÄÅÈ†≠ÁçéÁ≠âÂ§ßÁçéÔºöÁï´Èù¢ÂÑ™ÂåñÁÇ∫ÈÅ©‰∏≠Â§ßÂ∞è */
                                                            <div className={`
                                                                w-full max-w-xl bg-gradient-to-br from-amber-300 via-amber-500 to-amber-600 
                                                                text-red-900 font-black rounded-[40px] gold-glow border-4 border-white/80
                                                                flex items-center justify-center transition-all duration-300
                                                                ${isRolling ? 'animate-rolling blur-[1px]' : 'bounce-in'}
                                                                h-[65%] text-8xl md:text-9xl leading-none drop-shadow-[0_15px_25px_rgba(0,0,0,0.4)]
                                                            `}>
                                                                {currentDisplay[0]}
                                                            </div>
                                                        ) : (
                                                            /* Áôæ‰∫∫ÁçéÔºöÂÑ™ÂåñÁÇ∫ 5 Ê¨Ñ 4 Ë°å */
                                                            <div className="grid gap-3 w-full h-full p-2 grid-cols-5 items-center justify-center auto-rows-fr">
                                                                {currentDisplay.map((id, idx) => (
                                                                    <div key={idx} className={`
                                                                        bg-gradient-to-b from-amber-300 to-amber-500 text-red-900 font-black rounded-2xl 
                                                                        flex items-center justify-center shadow-lg border-2 border-white/60 
                                                                        transform transition-all duration-300
                                                                        ${isRolling ? 'animate-rolling blur-[0.5px] opacity-70' : 'bounce-in'}
                                                                        text-xl lg:text-3xl h-[85%] w-full
                                                                    `}>
                                                                        {id}
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                    
                                                    {isRolling && (
                                                        <div className="mt-2 text-center text-amber-200/40 font-bold text-[10px] animate-pulse tracking-[1em] shrink-0 uppercase">
                                                            Filtering Candidates...
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}

                                {activeTab === 'history' && (
                                    <div className="w-full max-w-4xl bg-red-900/30 backdrop-blur-sm rounded-[30px] p-6 border border-amber-600/30 flex flex-col h-[75%] shadow-2xl">
                                        <div className="flex justify-between items-center mb-4 pb-2 border-b border-amber-600/20">
                                            <h2 className="text-xl font-black text-amber-400 flex items-center gap-2"><Icon name="medal" size={20} /> 2026 È¥ªÈÅãÊ¶ú</h2>
                                        </div>
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-3 overflow-y-auto pr-2 custom-scrollbar">
                                            {winners.map((w, i) => (
                                                <div key={i} className="bg-red-800/50 p-4 rounded-xl border border-amber-600/10 flex items-center justify-between">
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-9 h-9 rounded-lg bg-gradient-to-br from-amber-500 to-amber-700 text-red-900 flex items-center justify-center font-black text-xs shadow">{w.id.slice(-4)}</div>
                                                        <div className="font-black text-xs text-white truncate w-16">{w.name}</div>
                                                    </div>
                                                    <div className="bg-red-600 text-amber-100 px-2 py-1 rounded text-[8px] font-black">{w.prizeName.slice(0,10)}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'setup' && (
                                    <div className="w-full max-w-4xl bg-red-900/30 rounded-[30px] p-6 border border-amber-600/30 flex flex-col h-[75%]">
                                        <h2 className="text-xl font-black text-amber-400 mb-4 flex items-center gap-2"><Icon name="users" /> ÂèÉË≥ΩÂêçÂñÆÂ∫´</h2>
                                        <div className="grid grid-cols-5 md:grid-cols-8 lg:grid-cols-10 gap-2 overflow-y-auto pr-2 custom-scrollbar">
                                            {participants.map((p, i) => {
                                                const isWon = winners.some(w => String(w.id) === String(p.id));
                                                return (
                                                    <div key={i} className={`p-2 rounded-lg border text-center transition-all ${isWon ? 'bg-red-950/50 border-red-900 text-red-800 line-through opacity-40' : 'bg-red-800/40 border-amber-600/10 text-white font-bold text-[10px]'}`}>
                                                        <div className="truncate">{p.name}</div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </main>

                    <footer className="shrink-0 flex justify-between items-center px-10 border-t border-amber-600/10 py-4 relative z-20">
                        <div className="flex items-center gap-6">
                            <div className="flex flex-col"><span className="text-[8px] text-amber-200/40 font-black uppercase mb-1">Total</span><span className="text-lg font-black text-white leading-none">{participants.length}</span></div>
                            <div className="w-px h-6 bg-amber-600/20"></div>
                            <div className="flex flex-col"><span className="text-[8px] text-amber-200/40 font-black uppercase mb-1 text-amber-500/80">Drawn</span><span className="text-lg font-black text-amber-400 leading-none">{totalWonCount}</span></div>
                            <div className="w-px h-6 bg-amber-600/20"></div>
                            <div className="flex flex-col"><span className="text-[8px] text-amber-200/40 font-black uppercase mb-1">Remaining</span><span className="text-lg font-black text-white leading-none">{participants.length - totalWonCount}</span></div>
                        </div>
                        
                        <div className="flex items-center gap-4">
                            <button onClick={fetchCloudData} className="flex items-center gap-2 bg-amber-600/20 hover:bg-amber-600/40 px-3 py-1.5 rounded-lg border border-amber-600/30 transition-all active:scale-95">
                                <Icon name="rotate-cw" size={12} className="text-amber-400" />
                                <span className="text-[10px] font-black text-amber-200">Âà∑Êñ∞Êï∏Êìö</span>
                            </button>
                            <div className="bg-red-900/80 px-4 py-1.5 rounded-full border border-amber-600/30 flex items-center gap-2">
                                <div className={`w-1.5 h-1.5 rounded-full animate-pulse shadow-[0_0_5px] ${syncStatus === 'error' ? 'bg-red-500 shadow-red-500' : 'bg-green-500 shadow-green-500'}`} />
                                <span className="text-[8px] font-black text-amber-200/40 uppercase tracking-[0.1em]">Cloud Sync</span>
                            </div>
                        </div>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
